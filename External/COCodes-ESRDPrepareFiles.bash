#!/bin/bash

# What this script will do:

# 1) Zip's NPANXX.csv
# 2) Updates the publish date in footer of HTM files;


# What this script requires:

# 1) CygWin installed with Zip package included;

# ------------------------------------------------------------------------------------

#	****************************************************************************************
#	*           VERSION CONTROL INFORMATION
#	****************************************************************************************
#	* CVS File:      $RCSfile$
#	* Commit Date:   $Date$ (UTC)
#	* Committed by:  $Author$
#	* CVS Revision:  $Revision$
#	* Checkout Tag:  $Name$ (Version/Build)
#	****************************************************************************************

# ------------------------------------------------------------------------------------

#####################
# DECLARE VARIABLES
#####################

# Directory Variables

BASEDIR="/cygdrive/d/cna/COCode-ESRDData/"
DOSBASEDIR="d:\\CNA\\COCode-ESRDData\\"

# Variables

PUBLISHSTAMP="This data was generated by the CNA Master Database on `date "+%F"`."


#####################
# START MAIN SCRIPT
#####################

# Add a column in CSV file with the publish date
sed -i "s/\"Remarks\"/\"Remarks\"\,\,\"${PUBLISHSTAMP}\"/" ${BASEDIR}NPANXX.csv
u2d ${BASEDIR}NPANXX.csv

# Zip NPANXX.csv File
cd ${BASEDIR}
zip ${BASEDIR}NPANXX.zip ${BASEDIR}NPANXX.csv

# Remove NPANXX.csv file
rm ${BASEDIR}NPANXX.csv

# Update the publish date in HTM Files and remove the NAs

for FILE in ${BASEDIR}*.htm
do
	sed "s/^....insertdatehere.../${PUBLISHSTAMP}/g" ${FILE} | sed "s/N\/A//g" | sed "s/n\/a//g" > ${FILE}_temp
	mv ${FILE}_temp ${FILE}
done

# FOLLOWING LINES USED TO MAIL ADMINS FOR CONFIRMATION OF JOB

#echo "COCode & ESRD Data export and prep job has fired" >> ${BASEDIR}/blatbody.txt
#echo >> ${BASEDIR}blatbody.txt
#echo >> ${BASEDIR}blatbody.txt

#blat "${DOSBASEDIR}blatbody.txt" -subject "COCode & ESRD Export and Prep Fired" -to browng,walshkel -server 192.168.10.151 -from database@saiccanada.com

#rm ${BASEDIR}blatbody.txt

#####################
# END SCRIPT
#####################
